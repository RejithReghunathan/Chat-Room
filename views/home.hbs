<script src="/javascripts/client.js"></script>

<script>
    window.console = window.console || function (t) { };
</script>

<script>
    if (document.location.search.match(/type=embed/gi)) {
        window.parent.postMessage("resize", "*");
    }
</script>

<script src="https://code.iconify.design/1/1.0.6/iconify.min.js"></script>

<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<script src="https://use.fontawesome.com/1c6f725ec5.js"></script>

<script type="text/javascript" src="https://unpkg.com/webcam-easy/dist/webcam-easy.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@3.0.3/dist/index.min.js"></script>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<style>
    .dropdown-toggle::after {
        content: none;
    }

    h1 {
        margin-bottom: .35rem;
    }

    #stopRecord {
        background-color: green;
        /* Green */
        border-width: medium;
        border-color: black;
        color: white;
        padding: 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        max-width: 50%;
        max-height: 15%;
        border-radius: 50%;
        left: 100px;
        right: 100px;
        position: relative;
    }

    #recordedAudio {
        left: 100px;
        right: 100px;
        position: relative;
    }
</style>

{{!-- <div class="green-background"></div> --}}
<div class="wrap">
    <section class="left">
        <div class="profile">
            <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1089577/user.jpg">

            <p id="username" style="margin-top: auto;margin-right: auto">{{userData.username}}</p>

            <input type="text" id="thisUser" value="{{userData.username}}" hidden>

            <input type="text" id="secondPerson" value="" hidden>

            <div class="icons">
                <i class="fa fa-commenting fa-lg" aria-hidden="true"></i>
                <i class="fa fa-bars fa-lg" aria-hidden="true"></i>
            </div>
        </div>
        <div class="wrap-search">
            <div class="search">
                <i class="fa fa-search fa" aria-hidden="true"></i>
                <input type="text" class="input-search" placeholder="Search users">
            </div>
        </div>
        <div class="contact-list">
            {{!-- active-contact --}}
            {{#each users}}

            <div class="contact" id="6" style="cursor: pointer;" onclick="getChat('{{this.username}}')"><img
                    src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1089577/contact7.JPG" alt="profilpicture">
                <div class="contact-preview">
                    <div class="contact-text">
                        <h1 class="font-name">{{this.username}}</h1>
                        <p class="font-preview">Last message</p>
                    </div>
                </div>
                <div class="contact-time">
                    <p>17:54</p>
                </div>

            </div>

            {{/each}}
        </div>
    </section>

    <section class="right">
        <div class="chat-head">
            {{!-- <img alt="profilepicture"> --}}

            <div class="chat-name">
                <h1 class="font-name" id="secondPersonChat" style="margin-left: 16px;"></h1>
                <p class="font-online"></p>
            </div>
            <i class="fa fa-search fa-lg" aria-hidden="true"></i>
            <i class="fa fa-paperclip fa-lg" aria-hidden="true"></i>
            <div class="dropdown" style="margin: auto;">
                <a class=" dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="false">
                    <i class="fa fa-bars fa-lg" aria-hidden="true" id="show-contact-information"></i>
                </a>

                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuLink">
                    <a class="dropdown-item" href="#">Profile</a>
                    <a class="dropdown-item" href="/logout">Logout</a>
                </div>
            </div>

            <i class="fa fa-times fa-lg" aria-hidden="true" id="close-contact-information"></i>

        </div>
        <div class="wrap-chat" id="wrap-chat" style="height: calc(100% - 60px);">

            <div class="chat" id="chat">

                <div class="" id="moddal">
                    <div id="" class="row p-0 m-0">
                        <div id="webcam-container" style="background-attachment: fixed;height: 100vh;
                            width: 100vw;display:none" class="webcam-container col-12  p-0 m-0">
                            <video id="webcam" autoplay playsinline width="640" height="480"></video>
                            <canvas id="canvas" class=""></canvas>
                            <div class="flash"></div>
                            <audio id="snapSound" src="audio/snap.wav" preload="auto"></audio>
                        </div>
                        <div id="cameraControls" class="cameraControls" style="margin-top: -16px;position: absolute;
                            bottom: 10vh;
                            z-index: 99999;
                            background: transparent;
                            opacity: 0.7;
                            padding: 10px;">
                            <a href="#" id="exit-app" title="Exit App" class="d-none"><span class="iconify"
                                    data-inline="false" data-icon="akar-icons:arrow-back"></span></a>
                            <a href="#" id="take-photo" title="Take Photo" style="display: none;"><i
                                    class="fa fa-camera"></i></a>
                            <a href="#" id="download-photo" download="selfie.png" target="_blank" title="Save Photo"
                                class="d-none"><span class="iconify" data-inline="false"
                                    data-icon="bx:bxs-download"></span></a>
                            {{!-- <a href="#" id="resume-camera" title="Resume Camera" class="d-none"><i
                                    class="material-icons">camera_front</i></a> --}}
                        </div>
                    </div>
                </div>


                <h2 id="noUserError" style="color: red;display: none;">You have to select a user</h2>

            </div>
            <div class="information"></div>
        </div>
        <div class="wrap-message" id="wrapMessage" style="display: none;">

            <form id="sendMessage" style="width: 100%;">
                <div class="row container-fluid">
                    <div class="col-sm-4" style="margin: auto;">
                        <i class="fa fa-smile-o fa-lg" aria-hidden="true" id="emojiIcon"></i>
                        <input type="file" hidden id="fileUpload" onchange="showImage(event)">

                        <i class="fa fa-paperclip fa-lg" onclick="fileUpload()" style="cursor: pointer;"
                            aria-hidden="true"></i>

                        <button type="button" id="modalButton" class="btn btn-info btn-lg" data-toggle="modal"
                            data-target="#myModal" hidden>Open Modal</button>

                        <!-- Modal -->
                        <div class="modal fade" id="myModal" role="dialog">
                            <div class="modal-dialog modal-dialog-centered">

                                <!-- Modal content-->
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal">&times;</button>

                                    </div>
                                    <div class="modal-body">
                                        <img src="" alt="" id="previewImage" style="height: 22rem;width: 23rem;">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-default" onclick="sendImage()" data-dismiss="modal"><span
                                                class="iconify" data-inline="false" id=""
                                                data-icon="fluent:send-16-filled" style="transform: rotate(
                                                    360deg
                                                    );
                                                        color: #aaaaaa;
                                                        text-align: center;
                                                        font-size: 1.33333333em;
                                                        line-height: 0.75em;
                                                        display: inline-block;
                                                        margin: auto;
                                                        vertical-align: -15%;
                                                        width: 60px;">
                                            </span></button>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <i class="fa fa-microphone fa-lg" id="record" style="cursor: pointer;" aria-hidden="true"></i>
                        {{!-- <button id="stopRecord" disabled> Stop</button> --}}

                        {{!-- <p>
                            <audio id=recordedAudio></audio>

                        </p> --}}
                        <i class="fa fa-camera fa-lg" style="cursor: pointer;" onclick="startCamera()"
                            aria-hidden="true"></i>

                    </div>

                    <div class="col-sm-7" style="margin-top: 8px;">
                        <div class="message">
                            <input type="text" id="outputMessage" class="input-message" placeholder="Type a message">
                        </div>
                    </div>

                    <div class="col-sm-1" style="margin: auto;">





                        <button id="send" class="btn" type="submit"><span class="iconify" data-inline="false" id=""
                                data-icon="fluent:send-16-filled" style="transform: rotate(
                360deg
                );
                    color: #aaaaaa;
                    text-align: center;
                    font-size: 1.33333333em;
                    line-height: 0.75em;
                    display: inline-block;
                    margin: auto;
                    vertical-align: -15%;
                    width: 60px;">
                            </span></button>
                    </div>

                </div>



            </form>

        </div>
    </section>
</div>

<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


<script>
    function getChat(secondPerson) {

        //$('#chat').empty();
        $("#chat > *").css('display', 'none');

        $("#secondPerson").val(secondPerson)
        let thisUser = $("#thisUser").val()
        document.getElementById('secondPersonChat').innerHTML = secondPerson

        $("#wrapMessage").show()

        $("#wrap-chat").height("calc(100% - 120px)");

        $.ajax({
            url: '/getChat',
            method: 'post',
            data: { username: secondPerson },

            success: (response) => {
                if (response) {

                    //let box = document.createElement("div");
                    //let timeDiv = document.createElement("div")
                    //box.innerText = response.content;
                    //timeDiv.innerText = response.date;

                    //if (response.to == thisUser) {
                    //    box.style.cssText = 'background: #ffffff;margin: 0px auto 10px 0px;border-radius: 7px;box-shadow: 0 2px 2px rgb(0 0 0 / 5%);padding: 5px 7px;width: 350px;max-width: 100%;position: relative;';
                    //    timeDiv.style.cssText = 'color: rgba(0,0,0,0.4);font-size: 0.6em;text-align: right;margin-top: -10px;';
                    //} else {
                    //    box.style.cssText = 'background: #dcf8c6;margin: 0px 0px 10px auto;border-radius: 7px;box-shadow: 0 2px 2px rgb(0 0 0 / 5%);padding: 5px 7px;width: 350px;max-width: 100%;position: relative;';
                    //    timeDiv.style.cssText = 'color: rgba(0,0,0,0.4);font-size: 0.6em;text-align: right;margin-top: -10px;';
                    //}

                    //$('#chat').append(box);
                    //$(box).append(timeDiv);



                    $.each(response, function (i, item) {


                        let box = document.createElement("div");
                        let timeDiv = document.createElement("div")

                        box.innerText = item.content;
                        timeDiv.innerText = item.date;

                        if (item.to == thisUser) {
                            box.style.cssText = 'background: #ffffff;margin: 0px auto 10px 0px;border-radius: 7px;box-shadow: 0 2px 2px rgb(0 0 0 / 5%);padding: 5px 7px;width: 350px;max-width: 100%;position: relative;';
                            timeDiv.style.cssText = 'color: rgba(0,0,0,0.4);font-size: 0.6em;text-align: right;margin-top: -10px;';
                        } else {
                            box.style.cssText = 'background: #dcf8c6;margin: 0px 0px 10px auto;border-radius: 7px;box-shadow: 0 2px 2px rgb(0 0 0 / 5%);padding: 5px 7px;width: 350px;max-width: 100%;position: relative;';
                            timeDiv.style.cssText = 'color: rgba(0,0,0,0.4);font-size: 0.6em;text-align: right;margin-top: -10px;';
                        }


                        $('#chat').append(box);
                        $(box).append(timeDiv);

                    });



                }
            }
        })

    }
</script>

<script src="/socket.io/socket.io.js"></script>
<script>

    var socket = io();

    console.log('id undo gooys', socket)

    $("#sendMessage").submit(function (e) {
        e.preventDefault(); // prevents page reloading
        let id = "entho id"
        console.log(id)
        let vall = $("#outputMessage").val()
        let thisUser = $("#thisUser").val()
        let secondUser = $("#secondPerson").val()
        let image = $('#fileUpload').val()
        console.log(image)

        console.log(vall, thisUser, secondUser)

        if (vall) {
            let msg = {
                from: thisUser,
                to: secondUser,
                content: vall
            }

            if (secondUser) {
                socket.emit("message", msg);
                $("#outputMessage").val("");
                return true;
            } else {
                document.getElementById('noUserError').style.display = "block"
            }
        }


    });


    //document.getElementById('send').addEventListener("click", () => {
    //    console.log('mone clicki')
    //    let txt = document.getElementById('inputMessage').value;
    //    socket.emit("message", txt)
    //})

    socket.on("board_content", (msg) => {
        console.log(msg)
        console.log(msg.to)
        let thisUser = $("#thisUser").val()
        let secondUser = $("#secondPerson").val()
        console.log(thisUser)


        if (msg.to == thisUser || msg.from == thisUser) {
            console.log(msg)

            let box = document.createElement("div");
            let timeDiv = document.createElement("div")

            box.innerText = msg.content;
            timeDiv.innerText = msg.date;

            if (msg.to == thisUser) {
                box.style.cssText = 'background: #ffffff;margin: 0px auto 10px 0px;border-radius: 7px;box-shadow: 0 2px 2px rgb(0 0 0 / 5%);padding: 5px 7px;width: 350px;max-width: 100%;position: relative;';
                timeDiv.style.cssText = 'color: rgba(0,0,0,0.4);font-size: 0.6em;text-align: right;margin-top: -10px;';
            } else {
                box.style.cssText = 'background: #dcf8c6;margin: 0px 0px 10px auto;border-radius: 7px;box-shadow: 0 2px 2px rgb(0 0 0 / 5%);padding: 5px 7px;width: 350px;max-width: 100%;position: relative;';
                timeDiv.style.cssText = 'color: rgba(0,0,0,0.4);font-size: 0.6em;text-align: right;margin-top: -10px;';
            }

            console.log('petti kittii')

            $('#chat').append(box);
            $(box).append(timeDiv);

            //const $messages = document.querySelector('#chat')

            //const autoscroll = () =>{
            //    $messages.scrollTop = $messages.scrollHeight
            //}
        }
    })

</script>

<script>
    const webcamElement = document.getElementById('webcam');
    const canvasElement = document.getElementById('canvas');
    const snapSoundElement = document.getElementById('snapSound');
    const webcam = new Webcam(webcamElement, 'user', canvasElement, snapSoundElement);

    function startCamera() {
        console.log('reached')
        $("#chat > *").css('display', 'none');
        $('#moddal').show()

        document.getElementById('take-photo').style.display = "block"
        document.getElementById('webcam-container').style.display = "block"

        webcam.start()
            .then(result => {
                console.log("webcam started");
            })
            .catch(err => {
                console.log(err);
            });
    }

    function beforeTakePhoto() {
        //$('.flash')
        //    .show()
        //    .animate({ opacity: 0.3 }, 500)
        //    .fadeOut(500)
        //    .css({ 'opacity': 0.7 });
        //window.scrollTo(0, 0);
        $('#webcam-control').addClass('d-none');
        $('#cameraControls').addClass('d-none');
    }

    function afterTakePhoto() {
        webcam.stop();
        $('#canvas').removeClass('d-none');
        $('#take-photo').addClass('d-none');
        $('#exit-app').removeClass('d-none');
        $('#download-photo').removeClass('d-none');
        $('#resume-camera').removeClass('d-none');
        $('#cameraControls').removeClass('d-none');
    }

    $("#take-photo").click(function () {
        console.log('reached')
        beforeTakePhoto();
        let picture = webcam.snap();
        document.querySelector('#download-photo').href = picture;
        $('#webcam').hide()
        afterTakePhoto();
    });

    function fileUpload() {
        $('#fileUpload').click()
        let file = $('#fileUpload').val()
        console.log('ithaanu chaadhanam', file)
    }

    let emojiIcon = document.querySelector('#emojiIcon')
    let outputMessage = document.querySelector('#outputMessage')

    let picker = new EmojiButton({
        position: 'right-start'
    })

    picker.on('emoji', (emoji) => {
        outputMessage.value += emoji
    })

    emojiIcon.addEventListener('click', () => {
        picker.pickerVisible ? picker.hidePicker() : picker.showPicker(emojiIcon)
    })

    //const chatBox = document.querySelector('.chat');
    //chatBox.scrollTop=chatBox.scrollHeight

</script>

<script>
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => { handlerFunction(stream) })


    function handlerFunction(stream) {
        rec = new MediaRecorder(stream);
        rec.ondataavailable = e => {
            audioChunks.push(e.data);
            if (rec.state == "inactive") {
                console.log('enthaayi mwonuseee')
                let blob = new Blob(audioChunks, { type: 'audio/mpeg-3' });
                recordedAudio.src = URL.createObjectURL(blob);
                recordedAudio.controls = true;
                recordedAudio.autoplay = true;
                sendData(blob)
            }
        }
    }

    function sendData(data) { }

    record.onclick = e => {
        console.log('I was clicked')
        record.disabled = true;

        //stopRecord.disabled = false;
        audioChunks = [];
        rec.start();
        console.log('skjfdlsjd')
    }

    stopRecord.onclick = e => {
        console.log("I was clicked on stop")
        record.disabled = false;
        stop.disabled = true;

        rec.stop();
    }

    function showImage(event) {
        $('#modalButton').click()
        document.getElementById('previewImage').src = URL.createObjectURL(event.target.files[0])
    }

    function sendImage(){
        $('#send').click()
    }
</script>